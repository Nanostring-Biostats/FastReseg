<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>runSegRefinement — runSegRefinement • FastReseg</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="runSegRefinement — runSegRefinement"><meta name="description" content="modular wrapper to evalute transcript groups in neighborhood, decide resegmentation operations and execute"><meta property="og:description" content="modular wrapper to evalute transcript groups in neighborhood, decide resegmentation operations and execute"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-#E6F3FC" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">FastReseg</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.0.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="external-link dropdown-item" href="https://www.biorxiv.org/content/10.1101/2024.12.05.627051v1.abstract">Working principles and Manuscript</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Workflow and core functions</h6></li>
    <li><a class="dropdown-item" href="../articles/tutorial.html">FastReseg to detect and correct segmentation error in spatial transcriptome data</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/Nanostring-Biostats/FastReseg/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>runSegRefinement</h1>
      <small class="dont-index">Source: <a href="https://github.com/Nanostring-Biostats/FastReseg/blob/HEAD/R/runSegRefinement.R" class="external-link"><code>R/runSegRefinement.R</code></a></small>
      <div class="d-none name"><code>runSegRefinement.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>modular wrapper to evalute transcript groups in neighborhood, decide resegmentation operations and execute</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">runSegRefinement</span><span class="op">(</span></span>
<span>  <span class="va">score_GeneMatrix</span>,</span>
<span>  chosen_cells <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">reseg_transcript_df</span>,</span>
<span>  reseg_cellID_coln <span class="op">=</span> <span class="st">"tmp_cellID"</span>,</span>
<span>  reseg_celltype_coln <span class="op">=</span> <span class="st">"group_maxCellType"</span>,</span>
<span>  transID_coln <span class="op">=</span> <span class="st">"transcript_id"</span>,</span>
<span>  transGene_coln <span class="op">=</span> <span class="st">"target"</span>,</span>
<span>  transSpatLocs_coln <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"z"</span><span class="op">)</span>,</span>
<span>  score_baseline <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  lowerCutoff_transNum <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  higherCutoff_transNum <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  neighbor_distance_xy <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  distance_cutoff <span class="op">=</span> <span class="fl">2.7</span>,</span>
<span>  spatialMergeCheck_method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"leidenCut"</span>, <span class="st">"geometryDiff"</span><span class="op">)</span>,</span>
<span>  cutoff_spatialMerge <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  leiden_config <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>objective_function <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CPM"</span>, <span class="st">"modularity"</span><span class="op">)</span>, resolution_parameter</span>
<span>    <span class="op">=</span> <span class="fl">1</span>, beta <span class="op">=</span> <span class="fl">0.01</span>, n_iterations <span class="op">=</span> <span class="fl">200</span><span class="op">)</span>,</span>
<span>  config_spatNW_transcript <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  return_intermediates <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  return_perCellData <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  includeAllRefGenes <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  seed_segRefine <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-score-genematrix">score_GeneMatrix<a class="anchor" aria-label="anchor" href="#arg-score-genematrix"></a></dt>
<dd><p>the gene x cell-type matrix of log-like score of gene in each cell type</p></dd>


<dt id="arg-chosen-cells">chosen_cells<a class="anchor" aria-label="anchor" href="#arg-chosen-cells"></a></dt>
<dd><p>the cell_ID of chosen cells need to be evaluate for re-segmentation</p></dd>


<dt id="arg-reseg-transcript-df">reseg_transcript_df<a class="anchor" aria-label="anchor" href="#arg-reseg-transcript-df"></a></dt>
<dd><p>the data.frame with transcript_id, target/geneName, x, y, cell_id for all transcript groups and the cell type of maximum transcript scores for each transcript group</p></dd>


<dt id="arg-reseg-cellid-coln">reseg_cellID_coln<a class="anchor" aria-label="anchor" href="#arg-reseg-cellid-coln"></a></dt>
<dd><p>the column name of cell_ID for all transcript groups in transcript_df</p></dd>


<dt id="arg-reseg-celltype-coln">reseg_celltype_coln<a class="anchor" aria-label="anchor" href="#arg-reseg-celltype-coln"></a></dt>
<dd><p>the column name of cell_type for all transcript groups in transcript_df</p></dd>


<dt id="arg-transid-coln">transID_coln<a class="anchor" aria-label="anchor" href="#arg-transid-coln"></a></dt>
<dd><p>the column name of transcript_ID in transcript_df</p></dd>


<dt id="arg-transgene-coln">transGene_coln<a class="anchor" aria-label="anchor" href="#arg-transgene-coln"></a></dt>
<dd><p>the column name of target or gene name in transcript_df</p></dd>


<dt id="arg-transspatlocs-coln">transSpatLocs_coln<a class="anchor" aria-label="anchor" href="#arg-transspatlocs-coln"></a></dt>
<dd><p>the column name of 1st, 2nd, optional 3rd spatial dimension of each transcript in transcript_df</p></dd>


<dt id="arg-score-baseline">score_baseline<a class="anchor" aria-label="anchor" href="#arg-score-baseline"></a></dt>
<dd><p>a named vector of score baseline for all cell type listed in neighborhood_df such that per cell transcript score higher than the baseline is required to call a cell type of high enough confidence</p></dd>


<dt id="arg-lowercutoff-transnum">lowerCutoff_transNum<a class="anchor" aria-label="anchor" href="#arg-lowercutoff-transnum"></a></dt>
<dd><p>a named vector of transcript number cutoff under each cell type such that higher than the cutoff is required to keep query cell as it is</p></dd>


<dt id="arg-highercutoff-transnum">higherCutoff_transNum<a class="anchor" aria-label="anchor" href="#arg-highercutoff-transnum"></a></dt>
<dd><p>a named vector of transcript number cutoff under each cell type such that lower than the cutoff is required to keep query cell as it is when there is neighbor cell of consistent cell type.</p></dd>


<dt id="arg-neighbor-distance-xy">neighbor_distance_xy<a class="anchor" aria-label="anchor" href="#arg-neighbor-distance-xy"></a></dt>
<dd><p>maximum cell-to-cell distance in x, y between the center of query cells to the center of neighbor cells with direct contact, same unit as input spatial coordinate. Default = NULL to use the 2 times of average 2D cell diameter.</p></dd>


<dt id="arg-distance-cutoff">distance_cutoff<a class="anchor" aria-label="anchor" href="#arg-distance-cutoff"></a></dt>
<dd><p>maximum molecule-to-molecule distance within connected transcript group, same unit as input spatial coordinate (default = 2.7 micron).
If set to NULL, the pipeline would first randomly choose no more than 2500 cells from up to 10 random picked ROIs with search radius to be 5 times of <code>neighbor_distance_xy</code>, and then calculate the minimal molecular distance between picked cells. The pipeline would further use the 5 times of 90% quantile of minimal molecular distance as <code>distance_cutoff</code>. This calculation is slow and is not recommended for large transcript data.frame.</p></dd>


<dt id="arg-spatialmergecheck-method">spatialMergeCheck_method<a class="anchor" aria-label="anchor" href="#arg-spatialmergecheck-method"></a></dt>
<dd><p>use either "leidenCut" (in 2D or 3D) or "geometryDiff" (in 2D only) method to determine whether a cell pair merging event is allowed in space (default = "leidenCut")</p></dd>


<dt id="arg-cutoff-spatialmerge">cutoff_spatialMerge<a class="anchor" aria-label="anchor" href="#arg-cutoff-spatialmerge"></a></dt>
<dd><p>spatial constraint on a valid merging event between two source transcript groups, default = 0.5 for 50% cutoff, set to 0 to skip spatial constraint evaluation for merging.
For <code>spatialMergeCheck_method = "leidenCut"</code>, this is the minimal percentage of transcripts shared membership between query cell and neighbor cells in leiden clustering results for a valid merging event.
For <code>spatialMergeCheck_method = "geometryDiff"</code>, this is the maximum percentage of white space change upon merging of query cell and neighbor cell for a valid merging event.</p></dd>


<dt id="arg-leiden-config">leiden_config<a class="anchor" aria-label="anchor" href="#arg-leiden-config"></a></dt>
<dd><p>(leidenCut) a list of configuration to pass to reticulate and <code><a href="https://r.igraph.org/reference/cluster_leiden.html" class="external-link">igraph::cluster_leiden</a></code> function, including objective_function, resolution_parameter, beta, n_iterations.</p></dd>


<dt id="arg-config-spatnw-transcript">config_spatNW_transcript<a class="anchor" aria-label="anchor" href="#arg-config-spatnw-transcript"></a></dt>
<dd><p>(leidenCut) configuration list to create spatial network at transcript level, see manual for <code>createSpatialDelaunayNW_from_spatLocs</code> for more details, set to NULL to use default config</p></dd>


<dt id="arg-return-intermediates">return_intermediates<a class="anchor" aria-label="anchor" href="#arg-return-intermediates"></a></dt>
<dd><p>flag to return intermediate outputs, including <code>neighborhoodDF_ToReseg</code> data.frame for neighborhood evaluation, <code>reseg_actions</code> list of resegmentation actions</p></dd>


<dt id="arg-return-percelldata">return_perCellData<a class="anchor" aria-label="anchor" href="#arg-return-percelldata"></a></dt>
<dd><p>flag to return gene x cell count matrix and per cell DF with updated mean spatial coordinates and new cell type</p></dd>


<dt id="arg-includeallrefgenes">includeAllRefGenes<a class="anchor" aria-label="anchor" href="#arg-includeallrefgenes"></a></dt>
<dd><p>flag to include all genes in <code>score_GeneMatrix</code> in the returned <code>updated_perCellExprs</code> with missing genes of value 0 (default = FALSE)</p></dd>


<dt id="arg-seed-segrefine">seed_segRefine<a class="anchor" aria-label="anchor" href="#arg-seed-segrefine"></a></dt>
<dd><p>seed for transcript error correction step, default = NULL to skip the seed</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>a list</p><dl><dt>updated_transDF</dt>
<dd><p>the updated transcript_df with <code>updated_cellID</code> and <code>updated_celltype</code> columns based on reseg_full_converter</p></dd>

<dt>neighborhoodDF_ToReseg</dt>
<dd><p>a data.frame for neighborhood environment of low-score transcript groups, output of <code>get_neighborhood_content</code> function, return when <code>return_intermediates</code> = TRUE</p></dd>

<dt>reseg_actions</dt>
<dd><p>a list of 4 elements describing how the resegmenation would be performed on original <code>transcript_df</code> by the group assignment of transcripts listed in <code>groupDF_ToFlagTrans</code>, output of <code>decide_ReSegment_Operations</code> function, return when <code>return_intermediates</code> = TRUE</p></dd>

<dt>updated_perCellDT</dt>
<dd><p>a per cell data.table with mean spatial coordinates, new cell type and resegmentation action after resegmentation, return when <code>return_perCellData</code> = TRUE</p></dd>

<dt>updated_perCellExprs</dt>
<dd><p>a gene x cell count sparse matrix for updated transcript data.frame after resegmentation, return when <code>return_perCellData</code> = TRUE</p></dd>


</dl></div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Patrick Danaher, Lidan Wu.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

